\section{Имитация СХД}

Разработка СХД ведется в два этапа:
\begin{enumerate}
\item Разработка библиотеки, позволяющей создавать дискретно-событийные модели  
\item Реализация модели, имитирующей СХД Татлин.
\end{enumerate}

В главах \ref{LIB} и \ref{Tatlin} даётся описание каждой из этих частей, соответственно.

\section{Реализация дискретно-событийной библиотеки Simlibrary для моделирования СХД}\label{LIB}

\subsection{Описание окружения имитации}

Имитация системы происходит при помощи объекта типа Environment, который полностью отражает текущее положение системы. Данный объект обладает следующими полями:

\textbf{currentTime}
Текущее время системы типа $float64$. Изменяется дискретными шагами.

\textbf{workers}
Словарь типа $map[uint64]*Process$, где в качестве ключа выступает идентификатор PID объекта, а в качестве значение указатель $Worker$.

\textbf{routesMap}  
Словарь типа  $map[Route]*Link$. Содержит значения обо всех путях, возможной в данной конфигурации компьютерной сети. $Route$ -- структура, имеющая в качестве своих полей $start$ и $finish$ -- указатели на хост, которые являются началом и концом пути, соответственно. Значение $*Link$ -- является указателем на сеть, по которой будет проходить передача пакетов в обе стороны.


\textbf{queue}
Поле типа $eventQueue$. Является глобавльным хранилищем всех событий во время имитации сложных сложных систем.

\textbf{mutex}         
Поле типа $sync.Mutex$. Примитив синхронизации нужный для того, чтобы обеспечивать консистентность доступа к данным, таким как очередь событий $queue$. 

\textbf{shouldStop}    
Поле типа $bool$. Во время прогона симуляции является равным 1. После того, как все события в имитации заканчиваются, либо при наличии специального события, выставляется в отрицательное значение и прогон прекращается.

\textbf{hostsMap}      
Словарь типа $map[string]HostInterface$. Содержит информацию обо всех хостах, которые имеются в симуляции. В качестве ключа словаря -- имя хоста, в качестве значения интерфейс типа HostInterface, который обобщает такие типы как $host$, $NetworkSwitch$ и $IOBalancer$.

\textbf{vesninServers}
Поле типа $[]*Host$. Является списком, который содержит информацию о рабочих дисковых контроллерах, поддреживающих отношения с клиентом, представленных в виде указателя на $*Host$.

\textbf{allVesninServers}
Поле типа $[]*Host$. Поле типа $[]*Host$. Является списком, который содержит информацию о обо всех (рабочих и нерабочих) дисковых контроллерах, поддреживающих отношения с клиентом, представленных в виде указателя на $*Host$.

\textbf{storagesMap}   
Словарь типа $map[string]*Storage$. В данном контейнере хранится информация обо всех дисках, примонтированных к системе хранения данных. В качестве ключа словаря используется идентификатор конечного хранилища данных, а качестве значения -- указатель на дисковое хранилище.

\textbf{linksMap}      
Словарь типа $map[string]*Link$. Контейнер, содержащий информацию обо всех сетях, представленных в данной симуляции.  В качестве ключа словаря используется идентификатор сети, а качестве значения -- сеть, по которой будет идти передача данных.

\textbf{FunctionsMap} 
Словарь типа $map[string]func(*Process, []string)$. Данный контейнер хранит информацию обо всех фукнциях, которые будует запущены в качестве горутин в начальный момент времени (время запуска симуляции). Функции должны быть объявлены в файле deployment.xml.  В качестве ключа словаря используется идентификатор функции, представленный в строковом виде, а качестве значения -- указатель на функцию.

\textbf{daemonList}  
Поле типа $[]*Process$. Является списком, который содержит информацию о горутинах, которые во время симуляции СХД, являются представлениями Unix-демонов и самостоятельно должны завершить своё исполнение.

\textbf{pid} 
Поле типа $ProcessID$. Указатель на функцию, которая исполняется в текущий момент времени.

\textbf{waitWorkerAmount} 
Поле типа $uint64$. Количество горутин, запущенных в текущий момент времени, завершения которых нужно ожидать для того, чтобы наполнить очередь актуальными текущими событиями. 

\textbf{stepEnd}        
Поле типа $chan interface{}$. Является средством коммукации горутин с главной ($master$) горутиной. В данный канал связи горутины, которые исполняются в текущий момент времени, сигнализируют о своём завершении.

\textbf{nextWorkers}
Поле типа $[]*Process$. Является списком, который содержит информацию о горутинах, которые должны буть запущены на следующем шаге работы имитации системы со статусом $OK$.

\textbf{timeOutWorkers}   
Поле типа $[]*Process$. Является списком, который содержит информацию о горутинах, которые должны буть запущены на следующем шаге работы имитации системы со статусом $TIMEOUT$.

\textbf{anomalyWorkers}   
Поле типа $[]*Process$. Является списком, который содержит информацию о горутинах, которые должны буть запущены на следующем шаге работы имитации системы со статусом $FAIL$.

\textbf{logsMap}  
Словарь типа $map[string]float64$. Данный контейнер хранит информацию, которая впоследствии будет выведена в виде логов системы.  В качестве ключа словаря используется идентификатор наблюдаемого значения, а качестве значения -- числовая характеристика данной величины.

\textbf{unitsMap} 
Словарь типа $map[string]float64$. Данный контейнер хранит информацию о единицах системы измерений, принятых в данной симуляции. В качестве ключа словаря используется идентификатор единицы измерения, а качестве значения -- численная характерстика относительно эталона.

\textbf{backupRoutesMap} 
Словарь типа  $map[Route]*Link$. Содержит значения обо всех запасных (backup) путях, возможной в данной конфигурации компьютерной сети. $Route$ -- структура, имеющая в качестве своих полей $start$ и $finish$ -- указатели на хост, которые являются началом и концом пути, соответственно. Значение $*Link$ -- является указателем на сеть, по которой будет проходить передача пакетов в обе стороны.

\textbf{HostLinksMap}
Словарь типа $map[HostInterface][]*Link$. Данный контейнер хранит информацию о сетях, к которым имеет доступ каждый хост. В качестве ключа словаря используется идентификатор хоста, а качестве значения -- список, состоящий из указателей на сеть, принадлежащих даннному хосту.

\textbf{LinkBackupsMap}  
Словарь типа $map[*Link]*Link$.  В качестве ключа словаря используется идентификатор конечного хранилища данных, а качестве значения -- указатель на дисковое хранилище.

\subsubsection{Функции Environment}
\textbf{func NewEnvironment() *Environment}

Входные аргументы: отсутсвуют.

Выходное значение: переменнная типа *Environment.

Описание функции:Создаёт и инициализует необходимые поля для функцирования симуляции, такие как:
\begin{itemize}
\item 		queue           
\item 		workers        
\item 		SendEventsNameMap 
\item 		ReceiveEventsNameMap
\item 		ReceiverSendersMap
\item 		stepEnd
\item 		logsMap
\item 		HostLinksMap
\item 		LinkBackupsMap
\end{itemize}

\textbf{func createUnits()}

Входные аргументы: отсутствуют.

Выходное значение: отсутствует.

Описание функции: Инциализирует единицы измерения необходимые при симуляции системы (показано в таблице ~\ref{tab:SI}\ref{tab:SI}{tab:SI}).
\begin{table}[]
\centering
\caption{Единицы системы измерений при моделировании}
\label{tab:SI}
\begin{tabularx}{\textwidth}{|X|X|}
TB   & $1000^4$ byte         \\
GB   & $1000^3$              \\
MB   & $1000^2$              \\
KB   & $1000$                \\
B    & $1$                   \\
GBps & $1000^3$ byte per sec \\
MBps & $1000^2$ byte per sec \\
KBps & $1000$ byte per sec   \\
Bps  & $1$ byte per sec      \\
Gf   & $1000^3$ flops        \\
Mf   & $1000^2$ flops        \\
Kf   & $1000$ flops          \\
f    & $1$ flops            
\end{tabularx}
\end{table}

\textbf{func (env *Environment) stopSimulation(EventInterface)}

Входные аргументы: указатель на объект типа *Environment.

Выходное значение: отсутствует.

Описание: Даннная функция останавливает исполнение программы путем выставления флага shouldStop в положительное значение.

\textbf{func (env *Environment) updateQueue(deltaTime float64) }

Входные аргументы: указатель на объект типа *Environment.

Выходное значение: отсутствует.

Описание: Даннная функция обновляет очередь событий за время $deltaTime$. 

\textbf{func (env *Environment) CreateTransferEvents()}

Входные аргументы: указатель на объект типа *Environment.

Выходное значение: отсутствует.

Описание: Даннная функция создаёт события, которые имитируют передачу данных от одного хоста к другому.

\textbf{func (env *Environment) Step() EventInterface }

Входные аргументы: указатель на объект типа *Environment.

Выходное значение: текущее событие симуляции.

Описание: Даннная функция осуществляет шаг симуляции, который состоит из следующих шагов. 
\begin{enumerate}
\item Cоздать события, которые имитируют передачу данных от одного хоста к другому.
\item Проверить является ли этот шаг симуляции последним.
\item Проверить симуляцию на возникновение дедлоков.
\item Получить событие из очереди с минимальным значением времени.
\item Обновить текущее время.
\item Обновить очередь событий за время, прошедшее с времени прошлого события.
\item Обработать коллбэки (callbaks) текущего события.
\item Проверить является ли этот шаг симуляции последним.

\end{enumerate}

\textbf{func (env *Environment) FindNextWorkers(event EventInterface)}

Входные аргументы: указатель на объект типа *Environment, текущее событие EventInterface.

Выходное значение: отсутствует. 

Описание: Даннная функция занимается поиском горутин, которые должны начать исполнение после выполнения текущего шага. Данный список включает в себе также горутины, которые начнут исполнение со статусами $OK$, $FAIL$, $TIMEOUT$.

\textbf{func (env *Environment) SendStartToSignalWorkers()}

Входные аргументы: указатель на объект типа *Environment.

Выходное значение: отсутствует. 

Описание: Даннная функция рассылает сигналы через каналы коммуикации горутинам, которые должны начать исполнение после выполнения текущего шага. Данный список включает в себе также горутины, которые начнут исполнение со статусами $OK$, $FAIL$, $TIMEOUT$.

\textbf{func (env *Environment) WaitWorkers() }

Входные аргументы: указатель на объект типа *Environment.

Выходное значение: отсутствует. 

Описание: Даннная функция дожидается выполнения задач текущими горутинами, которым были посланы сигналы на предыдущем этапе.



\subsection{Описание примитивов, использованных при имитации системы}

\subsubsection{Имитация сети}

Сеть имитируется при помощи структуры $Link$. Она обладает следующими полями (характеристиками). 

\textbf{name}
Идентификатор сети в текстовом представлении типа string. 

\textbf{state}	 float64
Степень соответсвия изначальному ресурсу, либо 1 минус деградация данной сети. Значение типа float64, может принимать значения от 0 до 1, где 0 соответсвует полной деградации сети, а 1 -- "фабричному" состоянию. 

\textbf{route}	 *Route
Указатель на структуру данных Route, которая содержит информацию о хостах, которые соединяет данная сеть. 

\textbf{minEvent}	
Указатель на минимальное событие-пакет *TransferEvent, которое передаётся в текущий момент по сети. 

\textbf{bandwidth}	 
Переменная типа float64. Пропускная способность сети, которая изменяется в байтах в секунду. 

\textbf{lastTimeRequest}
Переменная типа float64. Время последнего обращения к данной сети.

\textbf{mutex}	           
Примитив синхронизации типа sync.Mutex необходимой для корректности парального доступа к полям структуры данной сети.
 
\textbf{counter}
Переменная типа int64. Количество пакетов, которые передаются в текущий момент времени по сети. 


\textbf{func NewLink(bandwidth float64, name string) *Link}

Входные аргументы: bandwidth -- переменная типа float64. Содержит информацию о пропускной способности сети. name -- переменная типа string, имя сети. 

Выходное значение: Указатель созданную структуру, которая инкапсулирует сеть. 

Описание функции: Создаёт указатель созданную структуру, которая инкапсулирует сеть с именем name и пропускной способностью bandwidth и инициализирует необходимые поля сети, такие как:

\begin{itemize}
\item bandwidth 
\item mutex    
\item name   
\item state  
\end{itemize}




\textbf{func (link *Link) Put(e *TransferEvent)}

Входные аргументы: Указатель на структуру *Link, указатель на событие, которое должно передаваться по сети.

Выходное значение: отсутствует.

Описание функции: Данная функция добавляет событие в очередь событий, относящейся к сети link. 


\textbf{func (link *Link) EstimateTimeEnd(e *SendEvent)}

Входные аргументы: Указатель на структуру Link; указатель на событие SendEvent, которое должно передаваться по сети.

Выходное значение: отсутствует

Описание функции: Оценить время окончания  $t_{end}$ передачи события-пакета по данной сети по следующей формуле:

\[ t_{end} = t_0 + \dfrac{S}{\dfrac{B}{n}  \cdot q }  \], 

где $t_0$ -- это текущее время, \(S\) -- размер передаваемого пакета,  \(B\) -- пропускная способность сети, \(n\) -- количество пакетов, которые передаются в текущий момент времени,  \(q\) -- степень деградации сети. 


\textbf{func (env *Environment) FindNextTransferEvent()}

Входные аргументы: Указатель на структуру *Environment.

Выходное значение: Отсутствует. 

Описание функции: Данная функция "составляет" события, которые будут передаваться в текущий момент времени.  


\textbf{func GetRoute(route Route) *Link}

Входные аргументы: route переменна типа Route, содержащая информацию об начальном и конечном хостах.

Выходное значение: Указатель на структуру Link. 

Описание функции: Данная функция по имени route возвращает указатель на структуру Link.


\textbf{Route} обладает следующими полями.

Указатель на начальный	start. Тип  HostInterface

Указатель на конечный finish. Тип HostInterface



\subsubsection{Имитация хоста}
\textbf{name}      
Поле типа string. Является идентификатором объекта.  

\textbf{typeId} 
Поле типа string. Содержит информацию о классе устройств, которым принадлежит данный хост. 

\textbf{processes} 
Поле типа []*Process. Содержит информацию в виде списка указателей на Process обо всех текущих процессах, запущенных на данном хосте. 

\textbf{speed}     
Поле типа float64. Скорость работу данного хоста, измеряемая в flops.

\textbf{storage}   
Поле типа *Storage. Содержит указатель на диск, который примонтирован к данному хосту.

\textbf{traffic} 
Поле типа float64. Траффик в байт/с, который проходит через данный хост.

\textbf{logs} 
Поле типа interface\{\}. Текстовове представление логов данного хоста.

\textbf{Функции необходимые для имитации хоста}

\textbf{func (env *Environment) getHostByName(name string) HostInterface}

Входные аргументы: Аргумент name типа string.

Выходное значение: Объект типа HostInterface.

Описание функции: Данная функция по данному имени name возвращает объект типа HostInterface.


\textbf{func (process *Process) GetHost() HostInterface }

Входные аргументы: Указатель на процесс, владеющий в данное время исполнением.

Выходное значение: Объект типа HostInterface

Описание функции: Данная функция возвращает хост HostInterface, на котором в данное время исполняется текуща горутина. 

\textbf{func (host *Host) GetName() string }

Входные аргументы: Указатель на объект Host.

Выходное значение: Идентификатор хоста тип string.

Описание функции: Данная функция возвращает имя текущего хоста.


\textbf{func (host *Host) GetType() string }

Входные аргументы: Указатель на объект Host.

Выходное значение: Тип класса устройств к которым относится данный хост. Текстовое представление.

Описание функции: Данная функция возвращает тип текущего хоста.


\textbf{func (host *Host) GetDevTemp() float64 }

Входные аргументы: Указатель на объект Host.

Выходное значение: Температура данного хоста. Тип float64.

Описание функции: Данная функция возвращает температуру данного хоста в текущий момент времени.


\textbf{func (host *Host) GetTraffic() float64}

Входные аргументы: Указатель на объект Host.

Выходное значение: Суммарный (входной и выходной) траффик, проходящий, через данный хост. 

Описание функции: Данная функция возвращает значение суммарного (входного и выходного) траффика, проходящего, через данный хост.


\textbf{func (host *Host) AddTraffic(traffic float64)}

Входные аргументы: Указатель на объект Host.

Выходное значение: Отсутствует.

Описание функции: Данная функция кумулятивно увеличивает суммарное значение выходного траффика на значение traffic. 


\textbf{func (host *Host) GetLoad() int }

Входные аргументы: Указатель на объект Host.

Выходное значение: Загрузка процессора в текущий момент времени.

Описание функции: Данная функция возвращает загрузку процессора в текущий момент времени.


\textbf{func (host *Host) GetLogs() interface}

Входные аргументы: Указатель на объект Host.

Выходное значение: Логи компоненты системы. 

Описание функции: Данная функция возвращает логи компоненты системы. 


\textbf{func (host *Host) SetLogs(logs interface)}

Входные аргументы: Указатель на объект Host.

Выходное значение: Отсутствует.

Описание функции: Обновляет логи текущей компоненты системы. 


\textbf{func (host *Host) GetStorage() *Storage }

Входные аргументы: Указатель на объект Host.

Выходное значение: Указатель на объект Storage, объект симулирующий конечный дисковый носитель.

Описание функции: Данная функция возвращает указатель на объект Storage, объект симулирующий конечный дисковый носитель.


\textbf{func GetHostByName(hostName string) HostInterface }

Входные аргументы: Строка -- имя запрашиваемого хоста. 

Выходное значение: Указатель на объект Host.

Описание функции: Данная функция возвращает указатель на объект Host по его строковому указателю.

\subsubsection{Имитация конечного дискового хранилища}
\textbf{StorageType}
Структура данных StorageType необходима при модировании класса конечных дисковых носителей. Данная структура обладает следующими полями:

\textbf{	typeId}. Тип    string. Идентификатор класса, к которому принадлежит данный тип конечных дисковых носителей. 
\textbf{	writeRate}. Тип float64. Скорость данных на запись конечного дискового носителя.
\textbf{	readRate }. Тип float64. Скорость данных на чтение конечного дискового носителя.
\textbf{	size     }. Тип float64. Размер конечного дискового носителя.

Конкретная реализация конечного дискового носителя осуществляеся при помощи примитива Storage. Он обладает следующими полями. 

\textbf{	*StorageType}. Указатель на класс устройств конечного дискового носителя. 
\textbf{	name     }. Тип string. Идентификатор конечного дискового носителя.
\textbf{	readLink }. Тип *Link. Указатель структуру, по которой происходит запись на  конечный дисковый носитель.
\textbf{	writeLink }. Тип *Link. Указатель структуру, по которой происходит чтение на  конечный дисковый носитель.

\textbf{	usedSize }. Тип int64. Занятое место на конечном дисковом носителе.
\textbf{	logs }. Тип interface{}. Логи, принадлежащие конечному дисковому носителю.


\textbf{func NewStorage(storageType *StorageType, name string) *Storage}

Входные аргументы: Тип конечного носителя storageType, имя, создаваемого объекта, name. 

Выходное значение: Указатель на объект Storage. 

Описание функции: Данная функция создаёт объект, имитирующий поведение конечного диского носителя.

\textbf{func GetDiskDrives() map[string]*Storage}

Входные аргументы: отсутствуют.

Выходное значение: Словарь, где в качестве ключа используется строка, а качестве значения конечный дисковый носитель, имеющий такое же имя.

Описание функции: Данная функция возвращет словарь, содержащий сведения обо всех дисковых носителях, имеющихся в конкретной реализации. 

\textbf{func (storage *Storage) GetLogs() interface{}}

Входные аргументы: Указатель на структуру, имитирующую конечный дисковый накопитель.

Выходное значение: Логи дискового компонента. 

Описание функции: Данная функция возвращает логи дисковой компоненты. 

\textbf{func (storage *Storage) SetLogs(logs interface{})}

Входные аргументы: Указатель на структуру, имитирующую конечный дисковый накопитель.

Выходное значение:  Отсутствует.

Описание функции: Данная функция обновляет логи дисковой компоненты. 

\textbf{func (storage *Storage) GetName() string}

Входные аргументы: Указатель на структуру, имитирующую конечный дисковый накопитель.

Выходное значение: Имя конечного дискового накопителя.

Описание функции: Данная функция имя конечного дискового накопителя.

\textbf{func (storage *Storage) GetDevTemp() float64}

Входные аргументы: Указатель на структуру, имитирующую конечный дисковый накопитель.

Выходное значение: Температура конечного дискового накопителя.

Описание функции: Данная функция возвращает температуру конечного дискового накопителя.

\textbf{func (storage *Storage) GetRawCapacity() float64}

Входные аргументы: Указатель на структуру, имитирующую конечный дисковый накопитель.

Выходное значение: Заявленная ёмкость конечного дискового накопителя.

Описание функции: Данная функция возвращает ёмкость конечного дискового накопителя.

\textbf{func (storage *Storage) GetAvgReadSpeed() float64}

Входные аргументы: Указатель на структуру, имитирующую конечный дисковый накопитель.

Выходное значение: Средняя скорость на чтение конечного дискового накопителя.

Описание функции: Данная функция возвращает средную скорость на чтение конечного дискового накопителя.

\textbf{func (storage *Storage) GetAvgWriteSpeed() float64}

Входные аргументы: Указатель на структуру, имитирующую конечный дисковый накопитель.

Выходное значение: Средняя скорость на запись конечного дискового накопителя.

Описание функции: Данная функция возвращает средную скорость на запись конечного дискового накопителя.
 

\textbf{func (storage *Storage) GetDataInterfaceCNT() uint16}

Входные аргументы: Указатель на структуру, имитирующую конечный дисковый накопитель.

Выходное значение: Интерфейс передачи данных. 

Описание функции: Данная функция возвращает интерфейс передачи данных.

\textbf{func (storage *Storage) GetUsedSpace() float64 }

Входные аргументы: Указатель на структуру, имитирующую конечный дисковый накопитель.

Выходное значение:  Размер занятого места на конечном дисковом накопителе.

Описание функции: Данная функция возвращает размер занятого места на конечном дисковом накопителе.

\textbf{func (storage *Storage) GetFreeSpace() float64}

Входные аргументы: Указатель на структуру, имитирующую конечный дисковый накопитель.

Выходное значение: Размер свободного места на конечном дисковом накопителе.

Описание функции: Данная функция возвращает размер свободного места на конечном дисковом накопителе.

\textbf{func (storage *Storage) WritePacketSize() }

Входные аргументы: Указатель на структуру, имитирующую конечный дисковый накопитель.

Выходное значение: Отсутствует.

Описание функции: Данная функция имитирует запись на конечный дисковый накопитель одного пакета данных.

\textbf{func (storage *Storage) DeletePacketSize()}

Входные аргументы: Указатель на структуру, имитирующую конечный дисковый накопитель.

Выходное значение: Отсутствует.

Описание функции: Данная функция имитирует удаление с конечного дискового накопителя одного пакета данных.

\subsubsection{Имитация коммутатора внутренней управляющей сети СХД}
\textbf{NetworkSwitch}
Структура данных NetworkSwitch необходима при моделировании коммутатора внутренней управляющей сети СХД. Данная структура обладает следующими функциями:

\textbf{func(ns *NetworkSwitch) GetConnectedDevCnt() uint8}

Входные аргументы: Указатель на структуру, имитирующую коммутатор внутренней управляющей сети СХД.

Выходное значение: Количество подключенных устройств.

Описание функции: Данная функция возвращает количество подключенных устройств.

\textbf{func(ns *NetworkSwitch) GetOnlineSwitchesCnt() uint8}

Входные аргументы: Указатель на структуру, имитирующую коммутатор внутренней управляющей сети СХД.

Выходное значение: Количество одновременно включенных коммутаторов.

Описание функции: Данная функция возвращает количество одновременно включенных коммутаторов.

\subsubsection{Имитация фабрики PCI Express}
\textbf{PCIeFabric}
Структура данных PCIeFabric необходима при моделировании фабрики PCI Express. Данная структура обладает следующими функциями:

\textbf{func(pc *PCIeFabric) GetPCIeDevicesCnt() uint16}

Входные аргументы: Указатель на структуру, имитирующую фабрику PCI Express.

Выходное значение: Количество подключенных устройств.

Описание функции: Данная функция возвращает количество подключенных устройств.


\textbf{func(pc *PCIeFabric) GetPCIeMaxBandw() float64}

Входные аргументы: Указатель на структуру, имитирующую фабрику PCI Express.

Выходное значение: Максимальная пропускная способность.

Описание функции: Данная функция возвращает значение максимальной пропускной способности.

\subsubsection{Имитация балансировщика нагрузки}
\textbf{IOBalancer}
Структура данных IOBalancer необходима при моделировании балансировщика нагрузки. Данная структура обладает следующими полями:

\textbf{	*Host}. Наследование от базового типа Host, т.е помимо нижеперечисленных полей, тип IOBalancer обладает также и полями типа Host. 
\textbf{	readResponseTime}. Тип float64. Время отклика на запросы чтения.
\textbf{	writeResponseTime}. Тип float64. Время отклика на запросы записи.
\textbf{	writeRequests}. Тип float64. Количество запросов на запись в единицу времени.
\textbf{	readRequests}. Тип  float64. Количество запросов на чтение в единицу времени.
\textbf{	lastTime}. Тип float64. Время последнего запроса. 


\textbf{func(iob *IOBalancer) GetReadRequestsRate() float64}

Входные аргументы: Указатель на структуру, имитирующую балансировщик нагрузки.

Выходное значение: Количество обработанных запросов на чтение в секунду.

Описание функции: Данная функция возвращает количество обработанных запросов на чтение в секунду.

\textbf{func(iob *IOBalancer) GetWriteRequestsRate() float64}

Входные аргументы: Указатель на структуру, имитирующую балансировщик нагрузки.

Выходное значение: Количество обработанных запросов на запись в секунду. 

Описание функции: Данная функция возвращает количество обработанных запросов на запись в секунду.

\textbf{func(iob *IOBalancer) GetReadResponseDelay() float64}

Входные аргументы: Указатель на структуру, имитирующую балансировщик нагрузки.

Выходное значение: Время отклика при запросе на чтение. 

Описание функции: Данная функция возвращает значение времени отклика при запросе на чтение.

\textbf{func(iob *IOBalancer) GetWriteResponseDelay() float64}

Входные аргументы: Указатель на структуру, имитирующую балансировщик нагрузки.

Выходное значение: Время отклика при запросе на запись.

Описание функции: Данная функция возвращает значение временпи отклика при запросе на запись.

\textbf{func(iob *IOBalancer) GetReadDataVolume() float64}

Входные аргументы: Указатель на структуру, имитирующую балансировщик нагрузки.

Выходное значение: Объем передаваемых данных в режиме на чтение.

Описание функции: Данная функция возвращает объем передаваемых данных в режиме на чтение.

\textbf{func(iob *IOBalancer) GetWriteDataVolume() float64}

Входные аргументы: Указатель на структуру, имитирующую балансировщик нагрузки.

Выходное значение: Объем передаваемых данных в режиме на запись. 

Описание функции: Данная функция возвращает объем передаваемых данных в режиме на запись.

\textbf{func(iob *IOBalancer) GetReadRequestProcessTime() float64}

Входные аргументы: Указатель на структуру, имитирующую балансировщик нагрузки.

Выходное значение: Среднее время обработки запросов на чтение.

Описание функции: Данная функция возвращает среднее значение времени обработки запросов на чтение.

\textbf{func(iob *IOBalancer) GetWriteRequestProcessTime() float64}

Входные аргументы: Указатель на структуру, имитирующую балансировщик нагрузки.

Выходное значение: Среднее время обработки запросов на запись.

Описание функции: Данная функция возвращает возвращает среднее значение времени обработки запросов на запись.

\textbf{func(iob *IOBalancer) GetIoProcessingMethod() uint8}

Входные аргументы: Указатель на структуру, имитирующую балансировщик нагрузки.

Выходное значение: Способ обработки операций ввода-вывода (синхронный/асинхронный).

Описание функции: Данная функция возвращает способ обработки операций ввода-вывода (синхронный/асинхронный).

\textbf{func(iob *IOBalancer) GetReadCancelRate() float64}

Входные аргументы: Указатель на структуру, имитирующую балансировщик нагрузки.

Выходное значение: Количество аннулированных запросов на чтение в единицу времени.

Описание функции: Данная функция возвращает количество аннулированных запросов на чтение в единицу времени.

\textbf{func(iob *IOBalancer) GetWriteCancelRate() float64}

Входные аргументы: Указатель на структуру, имитирующую балансировщик нагрузки.

Выходное значение: Количество аннулированных запросов на запись в единицу времени. 

Описание функции: Данная функция возвращает количество аннулированных запросов на запись в единицу времени.

\textbf{func(iob *IOBalancer) GetBlockSize() uint16}

Входные аргументы: Указатель на структуру, имитирующую балансировщик нагрузки.

Выходное значение:  Размер блока данных при чтении/записи.

Описание функции: Данная функция возвращает  размер блока данных при чтении/записи.

\textbf{func(iob *IOBalancer) GetIOProcessCnt() uint8}

Входные аргументы: Указатель на структуру, имитирующую балансировщик нагрузки.

Выходное значение: Количество процессов, генерирующих запросы на чтение/запись.

Описание функции: Данная функция возвращает количество процессов, генерирующих запросы на чтение/запись.

\textbf{func(iob *IOBalancer) GetReadQueueLength() uint8}

Входные аргументы: Указатель на структуру, имитирующую балансировщик нагрузки.

Выходное значение: Длина очереди запросов на чтение для асинхронных операций ввода-вывода.

Описание функции: Данная функция возвращает длину очереди запросов на чтение для асинхронных операций ввода-вывода.

\textbf{func(iob *IOBalancer) GetWriteQueueLength() uint8}

Входные аргументы: Указатель на структуру, имитирующую балансировщик нагрузки.

Выходное значение: Длина очереди запросов на запись для асинхронных операций ввода-вывода. 

Описание функции: Данная функция возвращает длину очереди запросов на запись для асинхронных операций ввода-вывода.

\textbf{func(iob *IOBalancer) SetReadResponseDelay(rt float64}

Входные аргументы: Указатель на структуру, имитирующую балансировщик нагрузки; время отклика запросов на чтение rt.

Выходное значение: Отсутствует 

Описание функции: Данная функция устанавливает время отклика при запросах на чтение.

\textbf{func(iob *IOBalancer) SetWriteResponseDelay(rt float64}

Входные аргументы: Указатель на структуру, имитирующую балансировщик нагрузки; время отклика запросов на запись rt.

Выходное значение: Отсутствует.

Описание функции: Данная функция устанавливает время отклика при запросах на чтение.

\subsubsection{Имитация задач в симуляторе}
\textbf{Task}
Структура данных Task необходима при моделировании задач в симуляторе. Данная структура обладает следующими полями, характеризующими  её:

\textbf{	name}. Тип  string. Идентификатор задачи.

\textbf{	size}. Тип float64. Размер задачи в байтах. Необходим в случае передачи данных по сети или сохранении задачи на диск.

\textbf{	flops}. Тип   float64. Вычислительная сложность задачи во флопсах. Необходима для оценки времени, которое затратит хост при обработке данной задачи.

\textbf{	data}. Тип interface{}. Ссылка на дополнительную структуру данных, которыми может обладать данная задача. 

Соответственно, данный тип данных обладает следующим набором функций:

\textbf{func NewTask(name string, flops float64, size float64, data interface{}) *Task}

Входные аргументы: имя задачи, вычислительный размер задачи, размер задачи, ссылка на дополнительную структуру данных.

Выходное значение: Объект типа Task.

Описание функции: Данная функция создаёт задачу с параметрами, указанными во входных аргументах.

\textbf{	func (task *Task) GetName() string }

Входные аргументы: Отсутствуют.

Выходное значение: Идентификатор задачи. 

Описание функции: Данная функция возвращает идентификатор задачи.

\textbf{	func (task *Task) GetSize() float64 }

Входные аргументы: Отсутствуют.

Выходное значение: Размер задачи.

Описание функции: Данная функция возвращает размер задачи.

\textbf{	func (task *Task) GetFlops() float64}

Входные аргументы: Отсутствуют.

Выходное значение: Вычислительный размер задачи.

Описание функции: Данная функция возвращает вычислительный размер задачи.

\textbf{	func (task *Task) GetData() interface{} }

Входные аргументы: Отсутствуют.

Выходное значение: Ссылка на дополнительную структуру данных, которыми может обладать данная задача.

Описание функции: Данная функция возвращает ссылка на дополнительную структуру данных, которыми может обладать данная задача.

\textbf{	func (process *Process) Execute(task *Task) }

Входные аргументы: Задача, которую необходимо обработать.

Выходное значение: Статус выполения задачи.

Описание функции: Данная функция имитирует поведение СХД при исполнении задачи.


Структура Process обладает следующими методами.

\textbf{func (pid *ProcessID) Next() uint64}

Входные аргументы: Указатель на структуру, которая симулирует процесс.

Выходное значение: Идентификатор объекта.

Описание функции: Данная функция генерирует новый уникальный идентификатор для процесса.

\textbf{func ProcWrapper(processStrategy func(*Process, []string), w *Process, args []string)}

Входные аргументы: Указатель на структуру, которая симулирует процесс, указатель на функцию, которая будет симулировать стратегию, которая реализовавается на реальном хосте, набор аргументов, которым обладает хост.

Выходное значение: Процесс.

Описание функции: Данная функция по указанным входным параметрам создаёт и запускает процесс.


\textbf{func (process *Process) Daemonize() }

Входные аргументы: Указатель на структуру, которая симулирует процесс.

Выходное значение: Отсутствует.

Описание функции: Данная функция превращает текущий процесс в процесс-демон.


\textbf{func (p *Process) GetData() interface}

Входные аргументы: Указатель на структуру, которая симулирует процесс.

Выходное значение: Указатель на структуру данных о дополнительных параметрах, которыми обладает хост.

Описание функции: Данная функция возвращает указатель на струку данных о дополнительных параметрах, которыми обладает хост.


\textbf{func (p *Process) GetName() string}

Входные аргументы: Указатель на структуру, которая симулирует процесс.

Выходное значение: Имя процесса.

Описание функции: Данная функция .

\textbf{func (p *Process) GetEnv() *Environment}

Входные аргументы: Указатель на структуру, которая симулирует процесс.

Выходное значение: .

Описание функции: Данная функция .

\subsubsection{Имитация процессов}
\textbf{Process}
Структура данных Process необходима при моделировании процессов в симуляторе. Данная структура обладает следующими полями, характеризующими  её:

\textbf{	pid}. Тип uint64. Идетификатор процесса. 

\textbf{	env}. Тип        *Environment. Ссылка на Environment, в котором осуществляется симуляция. 

\textbf{	resumeChan}. Тип chan STATUS. Канал по которому осуществляется взаимодействие главной горутины с данной горутиной. 

\textbf{	host}. Тип       HostInterface. Хост на котором существует данный процесс. 

\textbf{	name}. Тип         string. Имя данного процесса. 

\textbf{	noMoreEvents}. Тип bool. Булева переменная, которая выставляется в положительное значение, при завершение работы процесса.

\textbf{	data}. Тип         interface. Ссылка на  структуру, в  которой может содержаться дополнительная информация о данном процессе.

\textbf{	Done}. Тип chan struct. Канал по которому данный процесс сообщает мастерской горутине о своём завершении. 



\subsection{Устройство очереди}

Наиболее важным элементом при реализации моделирования сложных систем является поддержание консистентности очереди событий. В текущей версии библиотеки она реализована при помощи встроенного в язык программирования интерфейса "container/heap". Данный интерфейс представляет структуру данных под названием дерево, которое обладает свойством, что каждая его узел является минимальным значением в его поддереве. Эта структура данных была выбрана для моделирования, т.к является наиболее распространенной при реализации очереди событий с приоритетом, которым в случае моделирования событийных имитаций является время окончания события. 

Для имплементации данного интерфейса были реализованы следующие функции, которые показаны в таблице \ref{tab:queue}. 

\begin{table}[]
\centering
\caption{Функции необходимые для реализации на очереди}
\label{tab:queue}
\begin{tabularx}{\textwidth}{|X|X|X|X|}
\hline
Функция                                      & Входные аргументы                                                          & Выходные аргументы                              & Описание функции                                                                                                                                                                                                         \\ \hline
func (eq eventQueue) Len() int               & -                                                                          & Длина очереди, тип int                          & Данная функция возвращает значение длины очереди.                                                                                                                                                                        \\ \hline
func (eq eventQueue) Less(i, j int) bool     & Индексы элементов очереди. Тип int                                         & Тип bool                                        & Данная функция задаёт правило сравнения и  сравнивает элемент очереди с индексом i c элементом с индексом j. В случае, если первый элемент больше, то возвращается логическое да, в противном случает -- логическое нет. \\ \hline
func (eq eventQueue) Swap(i, j int)          & Индексы элементов очереди. Тип int                                         & -                                               & Данная функция меняет местами элемент очереди с индексом i c элементов очереди с идексом j.                                                                                                                              \\ \hline
func (eq *eventQueue) Push(e interface\{\})  & Значение, которое необходимо добавить в очередь. Тип interface\{\}         & -                                               & Данная функция добавляет новый элемент e в очередь событий.                                                                                                                                                              \\ \hline
func (eq *eventQueue) Pop() interface\{\}    & -                                                                          & Минимальнй элемент в очереди. Тип interface\{\} & Данная функция извлекает минимальный элемент из очереди событий.                                                                                                                                                         \\ \hline
func(eq *eventQueue) Fix(h Interface, i int) & h - элемент в очереди, который нуждается в изменениях. i - новый приоритет & -                                               & Данная функция меняет приоритет у элемента h в очереди событий на приоритет i.                                                                                                                                           \\ \hline
\end{tabularx}
\end{table}

\subsection{Имитация аномалий}

В текущей версии реализации дискретно-событийной модели имплементировано два вида аномалий: хостов и сетей. 

\subsubsection{Аномалия сети}

Аномалия сети моделируется при помощи следующей последовательности действий:

\begin{enumerate}
\item Выставить пропускную способность, трафик через данную сеть равными нулю.
\item Найти все пакеты, передаваемые по этим сетям. 
\item Удалить пакеты из глобальной очереди событий. 
\item Уведомить процессы, которые принимали/передавали пакеты об статусом передачи $FAIL$.
\end{enumerate}

Реализация этой парадигмы показана на рис. ~\ref{fig:anom-link}.

\begin{figure}[!ht]
\centering
\includegraphics[width=10cm]{Kenenbek/images/anom-scheme-link.png}
\caption{Аномалия сети}
\label{fig:anom-link}
\end{figure}

\subsubsection{Аномалия хоста}

Аномалия хоста моделируется при помощи следующей последовательности действий:

\begin{enumerate}
\item Выставить вычислительную мощность хоста равной нулю.
\item Найти все исходящие/входящие провода из/в данный хост.
\item Выставить пропусные способности (степень деградации), трафик через данные сети равными нулю.
\item Найти все пакеты, передаваемые по этим сетям. 
\item Удалить их из глобальной очереди событий. 
\item Уведомить процессы, которые принимали/передавали пакеты об статусом передачи $FAIL$.
\item Прекратить выполнение задач, исполняемых на данном хосте, со статусом $FAIL$.

\end{enumerate}

Реализация этой парадигмы показана на рисунке ~\ref{fig:anom-host}.

\begin{figure}[!ht]
\centering
\includegraphics[width=10cm]{Kenenbek/images/anom-scheme-host.png}
\caption{Аномалия хоста}
\label{fig:anom-host}
\end{figure}

Восстановление хоста моделируется как показано на рис. ~\ref{fig:repai-host} при следующей последовательности действий:

\begin{enumerate}
\item Выставить степень деградации данного хоста равной нулю
\item Найти все исходящие/входящие провода из/в данный хост.
\item Выставить степень деградации данных сетей равной нулю.
\end{enumerate}

\begin{figure}[!ht]
\centering
\includegraphics[width=10cm]{Kenenbek/images/repair-host.png}
\caption{Восстановление хоста}
\label{fig:repai-host}
\end{figure}


\section{Моделирование Татлина}\label{Tatlin}
\subsection{Введение}

Для моделирования СХД Татлин были реализованы функции, как показано на рис.  ~\ref{fig:norm-tatlin}:

\begin{itemize}
\item ClientExecutor (Клиент) 
\item LoadBalancer (БН)
\item ServerExecutor (Контроллер (Веснин))
\item PCIeFabric (PCIe фабрика)
\begin{itemize}
\item CacheExecutorRead
\item CacheExecutorWrite
\end{itemize}
\item DiskExecutor (Диск)
\end{itemize}

\begin{figure}[!ht]
\centering
\includegraphics[width=10cm]{Kenenbek/images/norm.png}
\caption{Нормальный режим работы СХД Татлин. БН -- балансировщик нагрузки}
\label{fig:norm-tatlin}
\end{figure}

Балансировщик нагрузки (БН) при обращении клиента создаёт три соответсвующих процесса: один процесс отвечающий за логику серверной части, второй -- за PCIe фабрику и третий -- за конечный дисковый носитель. Описание каждого из них дано в последующих главах.

\subsection{Описание Клиента}
Клиентская часть реализует следующую последовательность действий:

\begin{enumerate}
\item\label{itm:client-a} Обращение к БН для того, чтобы узнать имя сервера, который будет обслуживать действующий запрос. 
\item Инициализировать соединение с сервером 

\item Цикл до тех пор пока не отправятся все пакеты:
	\begin{itemize}
		\item Отправка пакета данных 
			\begin{itemize}
				\item В случае аномалии вернуться к пункту \ref{itm:client-a}
			\end{itemize}
		\item Ожидание сообщения об успешной записи пакета на диск
			\begin{itemize}
				\item В случае аномалии вернуться к пункту \ref{itm:client-a}
			\end{itemize}
	\end{itemize}
\item Завершение соединения
\end{enumerate}



\subsection{Описание Балансировщика Нагрузки}
Данный процесс завершит свою деятельность после завершения других процессов. Балансировщик Нагрузки реализует следующую последовательность действий: 

\begin{itemize}

\item Бесконечный цикл:
	\begin{itemize}
		\item Ожидание запроса на соединение от клиента
		\item Установление соединения
		\item Выбор контроллера, который будет обслуживать запросы от клиента
		\item  Завершение соединения
	\end{itemize}
\end{itemize}

\subsection{Описание Серверной части}

Сервер реализует следующую последовательность действий: 

\begin{itemize}
\item Установка соединения с клиентом
\item Бесконечный цикл:
	\begin{itemize}
		\item Ожидание пакета от клиента
		\begin{itemize}
			\item Если произошла аномалия, то выйти из цикла
		\end{itemize}
		
		\item Отправка пакета PCIe фабрике
		\begin{itemize}
			\item Если произошла аномалия, то выйти из цикла
		\end{itemize}		
		\item  Отправка клиенту сообщения об успешной записи пакета на диск 
		\begin{itemize}
			\item Если произошла аномалия, то выйти из цикла
		\end{itemize}
		\begin{itemize}
			\item Если пакет последний, то выйти из цикла
		\end{itemize}
	\end{itemize}
\end{itemize}

\subsection{Описание PCIe фабрики }

Фабрика реализует следующую последовательность действий: 

\begin{itemize}
\item Установка соединения с сервером
\item Бесконечный цикл:
	\begin{itemize}
		\item Ожидание пакета от сервера
		\begin{itemize}
			\item Если произошла аномалия, то выйти из цикла
		\end{itemize}
		
		\item Отправка пакета на запись в кэш
		\item Отправка пакета на запись на диск		
		\item  Отправка серверу сообщения об успешной записи пакета на диск 
		\begin{itemize}
			\item Если произошла аномалия, то выйти из цикла
		\end{itemize}
		\begin{itemize}
			\item Если пакет последний, то выйти из цикла
		\end{itemize}
	\end{itemize}
\end{itemize}

\subsection{Описание Конечного дискового носителя}

Конечный дисковый носитель реализует следующую последовательность действий.

\begin{itemize}
\item Установка соединения с PCIe фабрикой
\item Бесконечный цикл:
	\begin{itemize}
		\item Ожидание пакета от сервера
		\begin{itemize}
			\item Если произошла аномалия, то выйти из цикла
		\end{itemize}
		
		\item Отправка пакета на запись в кэш
		\item Отправка пакета на запись на диск		
		\item  Отправка серверу сообщения об успешной записи пакета на диск 
		\begin{itemize}
			\item Если произошла аномалия, то выйти из цикла
		\end{itemize}
		\begin{itemize}
			\item Если пакет последний, то выйти из цикла
		\end{itemize}
	\end{itemize}
\end{itemize}

\subsection{Аномалии в СХД Татлин}
На данный в дискретно-событийной библиотеке реалиазовано два вида аномалий: серверов и сетей, что и нашло отражение при симулировании СХД Татлин.

Сценарий развития аномалии:

\begin{itemize}
\item Полностью выходит из строя один из серверов 
\item По получении сообщения о выхода из строя сервера, либо по таймауту по цепочке выходят из строя следующие процессы, обслуживающие передачу конкретного файла:
	\begin{itemize}
		\item  Клиент
		\item Балансировщик нагрузки
		\item PCIe фабрика
		\item Диск
	\end{itemize}
\end{itemize}

Схематическое представление выхода из строя сервера показано на рис. ~\ref{fig:bad-tatlin}.

\begin{figure}[!ht]
\centering
\includegraphics[width=10cm]{Kenenbek/images/bad.png}
\caption{Возникновение аномалии в СХД Татлин}
\label{fig:bad-tatlin}
\end{figure}

\subsection{Параметры запуска тестового прогона}

Начальные параметры компонент СХД Татлин заданы в файле $platform.xml$. Параметры дисковых контроллеров, сетей, конечных дисковых носителей и отображены в таблицаъъ\ref{tab:storage-contollers}, соответственно:

\begin{table}[]
\centering
\caption{Параметры дисковых котроллеров}
\label{tab:storage-contollers}
\begin{tabularx}{\textwidth}{|l|l|l|} 
\hline
                     & Имя       & Скорость, Гфс  \\ 
\hline
Storage controller 1 & Server 1~ & 1              \\ 
\hline
Storage controller 2 & Server 2~ & 1              \\ 
\hline
Storage controller 3 & Server 3~ & 1              \\ 
\hline
Storage controller 4 & Server 4~ & 1              \\
\hline
\end{tabularx}
\end{table}


\begin{table}
\centering
\caption{Параметры сетей}
\label{tab:links}
\begin{tabularx}{\textwidth}{|l|l|l|} 
\hline
Имя сети               & Скорость, ГБ/с & Задержка сети, мс  \\ 
\hline
Client\_Server1        & 10             & 0                  \\ 
\hline
Client\_Server2        & 10             & 0                  \\ 
\hline
Client\_Server3        & 10             & 0                  \\ 
\hline
Client\_Server4        & 10             & 0                  \\ 
\hline
Server1\_FabricManager & 12             & 0                  \\ 
\hline
Server2\_FabricManager & 12             & 0                  \\ 
\hline
Server3\_FabricManager & 12             & 0                  \\ 
\hline
Server4\_FabricManager & 12             & 0                  \\ 
\hline
FabricManager\_SSD     & 12             & 0                  \\ 
\hline
FabricManager\_JBOD1   & 2              & 0                  \\ 
\hline
FabricManager\_JBOD2   & 2              & 0                  \\
\hline
\end{tabularx}
\end{table}
